{% extends 'base.html' %}

{% block title %}Student Dashboard - College Attendance Management System{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Read-Only Notice -->
    <div class="alert alert-info border-bottom mb-4" role="alert">
        <i class="fas fa-lock"></i> <strong>READ-ONLY VIEW:</strong> This is your attendance dashboard. You can view your attendance records but cannot make any changes.
    </div>

    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 style="color: #2c3e50;">
                <i class="fas fa-user-graduate"></i> Welcome, {{ student.name }}!
            </h2>
            <p class="text-muted">
                <strong>Hall Ticket ID:</strong> {{ student.hall_ticket_id }} | 
                <strong>Branch:</strong> {{ student.get_branch_display }} | 
                <strong>Year:</strong> {{ student.get_year_display }}
            </p>
        </div>
        <div class="col-md-4">
            <a href="{% url 'student_attendance_details' %}" class="btn btn-primary float-end">
                <i class="fas fa-list"></i> View Detailed Attendance
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-4 mb-4">
        <!-- Total Classes Card -->
        <div class="col-md-3 col-sm-6">
            <div class="stat-box">
                <div class="stat-value">{{ total_classes }}</div>
                <div class="stat-label">Total Classes</div>
            </div>
        </div>

        <!-- Classes Attended Card -->
        <div class="col-md-3 col-sm-6">
            <div class="stat-box">
                <div class="stat-value" style="color: #27ae60;">{{ attended_classes }}</div>
                <div class="stat-label">Classes Attended</div>
            </div>
        </div>

        <!-- Classes Absent Card -->
        <div class="col-md-3 col-sm-6">
            <div class="stat-box">
                <div class="stat-value" style="color: #e74c3c;">{{ absent_classes }}</div>
                <div class="stat-label">Classes Absent</div>
            </div>
        </div>

        <!-- Attendance Percentage Card -->
        <div class="col-md-3 col-sm-6">
            <div class="stat-box">
                <div class="stat-value" style="color: #3498db;">{{ attendance_percentage }}%</div>
                <div class="stat-label">Attendance %</div>
            </div>
        </div>
    </div>

    <!-- Attendance Percentage Indicator -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-bar"></i> Attendance Overview
                </div>
                <div class="card-body">
                    <!-- Current Attendance Progress Bar -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Current Attendance Percentage</span>
                            <strong>{{ attendance_percentage }}%</strong>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" 
                                 data-width="{{ attendance_percentage }}" 
                                 aria-valuenow="{{ attendance_percentage }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    <script>
                    document.querySelector('[data-width]').style.width = document.querySelector('[data-width]').getAttribute('data-width') + '%';
                    </script>

                    <!-- Attendance Status Alert -->
                    {% if is_below_threshold %}
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning!</strong> Your attendance percentage is below 75%. 
                        You need to improve your attendance to meet the required standards.
                    </div>
                    {% else %}
                    <div class="alert alert-success" role="alert">
                        <i class="fas fa-check-circle"></i>
                        <strong>Great!</strong> Your attendance is above 75%. Keep up the good work!
                    </div>
                    {% endif %}

                    <!-- Attendance Statistics -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <p class="mb-2">
                                <i class="fas fa-calendar-check text-success"></i> 
                                <strong>Classes Attended:</strong> {{ attended_classes }}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2">
                                <i class="fas fa-calendar-times text-danger"></i> 
                                <strong>Classes Absent:</strong> {{ absent_classes }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Predictive Analytics Card -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-crystal-ball"></i> If You Miss One More Class
                </div>
                <div class="card-body text-center">
                    <div class="percentage-indicator percentage-{% if percentage_if_absent_one_more >= 75 %}good{% elif percentage_if_absent_one_more >= 50 %}warning{% else %}danger{% endif %}">
                        {{ percentage_if_absent_one_more }}%
                    </div>
                    <p class="mt-3 text-muted small">
                        Your attendance would drop to <strong>{{ percentage_if_absent_one_more }}%</strong> 
                        if you miss one more class.
                    </p>
                    {% if percentage_if_absent_one_more < 75 and is_below_threshold %}
                    <div class="alert alert-warning mt-3" role="alert">
                        <i class="fas fa-exclamation-circle"></i>
                        <small>You cannot afford to miss any more classes!</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Attendance Records -->
    {% if recent_attendances %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-history"></i> Recent Attendance Records (Last 10 Classes)
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Subject</th>
                                <th>Topic</th>
                                <th>Faculty</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for attendance in recent_attendances %}
                            <tr>
                                <td>{{ attendance.schedule.date|date:"d/m/Y" }}</td>
                                <td>{{ attendance.schedule.subject }}</td>
                                <td>{{ attendance.schedule.topic }}</td>
                                <td>{{ attendance.schedule.faculty.name }}</td>
                                <td>
                                    {% if attendance.status == 'P' %}
                                    <span class="badge badge-success">
                                        <i class="fas fa-check"></i> Present
                                    </span>
                                    {% else %}
                                    <span class="badge badge-danger">
                                        <i class="fas fa-times"></i> Absent
                                    </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer text-center">
                    <a href="{% url 'student_attendance_details' %}" class="text-decoration-none">
                        View All Attendance Records <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info" role="alert">
        <i class="fas fa-info-circle"></i>
        No attendance records available yet. Attendance will appear here once faculty mark your classes.
    </div>
    {% endif %}
</div>

<style>
    /* Custom styling for attendance percentage indicator */
    .percentage-indicator {
        border-radius: 8px;
        padding: 1.5rem;
    }
</style>
{% endblock %}
