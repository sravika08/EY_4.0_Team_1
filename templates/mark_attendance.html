{% extends 'base.html' %}

{% block title %}Mark Attendance - College Attendance Management System{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h2 style="color: #2c3e50;">
                <i class="fas fa-clipboard-check"></i> Mark Attendance
            </h2>
            <p class="text-muted">
                <strong>Date:</strong> {{ schedule.date|date:"d/m/Y" }} | 
                <strong>Subject:</strong> {{ schedule.subject }} | 
                <strong>Topic:</strong> {{ schedule.topic }}
            </p>
        </div>
        <div class="col-auto">
            <a href="{% url 'faculty_dashboard' %}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Class Details Card -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <i class="fas fa-book-open"></i> Class Details
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-2">
                        <strong>Subject:</strong> {{ schedule.subject }}
                    </p>
                    <p class="mb-2">
                        <strong>Topic:</strong> {{ schedule.topic }}
                    </p>
                </div>
                <div class="col-md-6">
                    <p class="mb-2">
                        <strong>Date:</strong> {{ schedule.date|date:"l, d/m/Y" }}
                    </p>
                    <p class="mb-0">
                        <strong>Faculty:</strong> {{ schedule.faculty.name }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Form -->
    <div class="card">
        <div class="card-header">
            <i class="fas fa-users-check"></i> Mark Attendance for {{ students.count }} Students
        </div>
        <div class="card-body">
            <form method="POST" id="attendanceForm">
                {% csrf_token %}

                <!-- Summary Info -->
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle"></i>
                    <strong>Total Students:</strong> {{ students.count }} | 
                    <strong>Branch:</strong> {{ faculty.get_branch_display }} | 
                    <strong>Year:</strong> {{ faculty.get_year_display }}
                </div>

                <!-- Attendance Table -->
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 10%;">S.No</th>
                                <th style="width: 20%;">Hall Ticket ID</th>
                                <th style="width: 40%;">Student Name</th>
                                <th style="width: 30%;">Attendance Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr>
                                <td><strong>{{ forloop.counter }}</strong></td>
                                <td><strong>{{ student.hall_ticket_id }}</strong></td>
                                <td>{{ student.name }}</td>
                                <td>
                                    <div class="btn-group" role="group" style="width: 100%;">
                                        <input type="radio" class="btn-check" 
                                               id="student_{{ student.id }}_p" 
                                               name="student_{{ student.id }}" 
                                               value="P" required>
                                        <label class="btn btn-outline-success" 
                                               for="student_{{ student.id }}_p">
                                            <i class="fas fa-check-circle"></i> Present
                                        </label>

                                        <input type="radio" class="btn-check" 
                                               id="student_{{ student.id }}_a" 
                                               name="student_{{ student.id }}" 
                                               value="A" required>
                                        <label class="btn btn-outline-danger" 
                                               for="student_{{ student.id }}_a">
                                            <i class="fas fa-times-circle"></i> Absent
                                        </label>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Form Errors -->
                {% if form.non_field_errors %}
                <div class="alert alert-danger mt-3" role="alert">
                    <i class="fas fa-exclamation-circle"></i>
                    <strong>Error:</strong>
                    {% for error in form.non_field_errors %}
                    {{ error }}<br>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Submit Buttons -->
                <div class="mt-4 d-flex gap-2">
                    <button type="submit" class="btn btn-success btn-lg flex-grow-1">
                        <i class="fas fa-save"></i> Save Attendance
                    </button>
                    <a href="{% url 'faculty_dashboard' %}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Instructions -->
    <div class="alert alert-light mt-4 border" role="alert">
        <h6 class="alert-heading"><i class="fas fa-lightbulb"></i> Instructions</h6>
        <ul class="mb-0 small">
            <li>Select whether each student is <strong>Present</strong> or <strong>Absent</strong></li>
            <li>All students must be marked before submitting</li>
            <li>Once saved, the attendance records will be stored in the system</li>
            <li>You can later edit the attendance if needed by marking the same class again</li>
        </ul>
    </div>
</div>

<script>
    // Form validation on submit
    (function() {
        var form = document.getElementById('attendanceForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                var studentCount = document.querySelectorAll('input[type="radio"]').length / 2;
                var allMarked = true;
                
                for (var i = 0; i < studentCount; i += 2) {
                    var radios = document.querySelectorAll('input[type="radio"]').length > i ? true : false;
                    if (!radios) {
                        allMarked = false;
                        break;
                    }
                }
                
                if (!allMarked) {
                    e.preventDefault();
                    alert('Please mark attendance for all students before submitting.');
                }
            });
        }
    })();

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 's' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            var form = document.getElementById('attendanceForm');
            if (form) form.submit();
        }
    });
</script>

<style>
    .btn-group {
        display: flex;
    }
    
    .btn-check:checked + .btn {
        font-weight: bold;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}
